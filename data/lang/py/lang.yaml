# Python language descriptor for morloc compiler
# Metadata fields (read by LangRegistry) + descriptor fields (read by generic translator)

# Identity and metadata
name: py
extension: py
aliases: ["python", "python3"]
is_compiled: false
run_command: ["python3"]
serial_type: "str"
cost: 3
preamble:
  - 'sys.path = [os.path.expanduser("."), os.path.expanduser("{{opt}}"), os.path.expanduser("{{lib}}")] + sys.path'
  - "import importlib"
  - "import pymorloc as morloc"

# Literals
ldBoolTrue: "True"
ldBoolFalse: "False"
ldNullLiteral: "None"

# Constructors
ldListStyle: bracket
ldTupleConstructor: ""
ldRecordConstructor: "OrderedDict"
ldRecordSeparator: "="

# Access styles
ldIndexStyle: zero_bracket
ldKeyAccess: "bracket"
ldFieldAccess: dot

# Serialize/deserialize
ldSerializeFn: "morloc.put_value"
ldDeserializeFn: "morloc.get_value"

# Foreign call
ldForeignCallFn: "morloc.foreign_call"
ldForeignCallIntSuffix: ""

# Remote call
ldRemoteCallFn: "morloc.remote_call"

# Record handling
ldDictStyleRecords: true
ldQuoteRecordKeys: false

# Import syntax
ldQualifiedImports: true
ldIncludeRelToFile: false

# Template fields
ldAssignOp: "="
ldLambdaTemplate: "lambda {{args}}: {{body}}"
ldSuspendExpr: "(lambda: {{expr}})"
ldSuspendBlock: ""
ldPartialTemplate: "functools.partial({{fn_with_context}})"
ldImportTemplate: "{{namespace}} = importlib.import_module(\"{{module_path}}\")"
ldSocketPathTemplate: "os.path.join(global_state[\"tmpdir\"], {{socket}})"
ldResourcePackTemplate: "struct.pack('iiii', {{mem}}, {{time}}, {{cpus}}, {{gpus}})"
ldReturnTemplate: "return({{expr}})"
ldFuncDefHeader: "def {{name}}({{args}}):"
ldBlockStyle: indent
ldBlockEnd: ""
ldErrorWrapOpen: "try:"
ldErrorWrapClose:
  - "except Exception as e:"
  - "    raise RuntimeError(f\"Error (pool daemon in {{name}}):\\n{e!s}\")"
ldPatternStyle: fstring
ldMapStyle: loop_append
ldDispatchLocalHeader: "dispatch = {"
ldDispatchLocalEntry: "    {{mid}}: {{name}},"
ldDispatchLocalFooter: "}"
ldDispatchRemoteHeader: "remote_dispatch = {"
ldDispatchRemoteEntry: "    {{mid}}: {{name}}_remote,"
ldDispatchRemoteFooter: "}"

# Pool template (loaded from pool.py, left empty here)
ldPoolTemplate: ""
ldBreakMarker: "# <<<BREAK>>>"
ldCommentMarker: "#"
